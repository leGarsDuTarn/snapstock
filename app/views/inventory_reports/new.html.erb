<%# app/views/inventory_reports/new.html.erb %>

<div class="d-flex align-items-center justify-content-between mb-4 sticky-top bg-body pt-3 pb-2 border-bottom" style="z-index: 1000;">
  <div>
    <h1 class="h4 fw-bold mb-0">Nouveau Relevé</h1>
    <div class="text-muted small"><%= @store.name %></div>
  </div>
  <button type="submit" form="new_inventory_report" class="btn btn-primary shadow fw-bold">
    <i class="fa-solid fa-check me-2"></i>Valider
  </button>
</div>

<%= simple_form_for [@store, @inventory_report], html: { id: "new_inventory_report" } do |f| %>

  <%# Date du rapport %>
  <div class="card border-0 shadow-sm mb-4">
    <div class="card-body">
      <%= f.input :report_date, label: "Date du passage", html5: true, input_html: { class: "fw-bold" } %>
    </div>
  </div>

  <%# Groupement par catégorie %>
  <% groups = @inventory_report.inventory_items.group_by { |i| i.product.category&.name || "Autres" } %>

  <%# Accordéon Bootstrap %>
  <div class="accordion" id="categoriesAccordion">
    <% groups.each_with_index do |(category_name, items), index| %>
      <% collapse_id = "collapse-cat-#{index}" %>
      <% heading_id = "heading-cat-#{index}" %>

      <div class="accordion-item border-0 shadow-sm mb-3">
        <%# HEADER DE LA CATEGORIE %>
        <h2 class="accordion-header" id="<%= heading_id %>">
          <button class="accordion-button bg-primary text-white fw-bold <%= 'collapsed' unless index == 0 %>"
                  type="button"
                  data-bs-toggle="collapse"
                  data-bs-target="#<%= collapse_id %>"
                  aria-expanded="<%= index == 0 ? 'true' : 'false' %>"
                  aria-controls="<%= collapse_id %>">
            <span class="small opacity-75 me-2">Catégorie</span>
            <span class="text-uppercase"><%= category_name %></span>
          </button>
        </h2>

        <%# CONTENU PLIABLE %>
        <div id="<%= collapse_id %>"
             class="accordion-collapse collapse <%= 'show' if index == 0 %>"
             aria-labelledby="<%= heading_id %>"
             data-bs-parent="#categoriesAccordion">
          <div class="accordion-body p-0">
            <div class="list-group list-group-flush">

              <%# En-tête des colonnes %>
              <div class="list-group-item bg-light fw-bold text-muted small text-uppercase d-flex text-center align-items-center py-1">
                <div style="width: 40%;" class="text-start ps-2">Produit</div>
                <div style="width: 20%;" class="text-danger"><i class="fa-solid fa-triangle-exclamation"></i></div>
                <div style="width: 20%;" class="text-warning"><i class="fa-solid fa-tag"></i></div>
                <div style="width: 20%;"><i class="fa-solid fa-box"></i></div>
              </div>

              <%= f.simple_fields_for :inventory_items, items do |item_form| %>
                <% product = item_form.object.product %>

                <%# La row avec le controller Stimulus %>
                <div class="list-group-item py-3 item-row" data-controller="inventory-row">
                  <%= item_form.input :product_id, as: :hidden %>

                  <div class="d-flex align-items-center">

                    <%# 1. INFO PRODUIT %>
                    <div style="width: 40%;" class="pe-2">
                      <div class="fw-bold text-dark lh-sm mb-0" style="font-size: 0.9rem;"><%= product.name %></div>
                      <div class="small text-muted font-monospace" style="font-size: 0.75rem;">PCB: <%= product.pcb %></div>
                    </div>

                    <%# 2. RUPTURE %>
                    <div style="width: 20%;" class="d-flex justify-content-center border-end">
                      <div class="form-check form-switch form-switch-lg">
                        <%= item_form.check_box :is_out_of_stock,
                            class: "form-check-input rupture-toggle",
                            data: {
                              inventory_row_target: "rupture",
                              action: "change->inventory-row#toggleRupture"
                            } %>
                      </div>
                    </div>

                    <%# 3. ETIQUETTE %>
                    <div style="width: 20%;" class="d-flex justify-content-center border-end">
                      <div class="form-check form-switch">
                        <%= item_form.check_box :missing_label, class: "form-check-input border-warning label-toggle" %>
                      </div>
                    </div>

                    <%# 4. QUANTITÉ %>
                    <div style="width: 20%;" class="ps-2">
                      <%= item_form.input :cases_added, label: false, placeholder: "-",
                          input_html: {
                            class: "text-center form-control form-control-sm bg-light fw-bold",
                            data: { inventory_row_target: "quantity" },
                            autocomplete: "off"
                          } %>
                    </div>
                  </div>
                </div>
              <% end %>
            </div>
          </div>
        </div>
      </div>
    <% end %>
  </div>
<% end %>
